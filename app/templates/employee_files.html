{% extends "layout.html" %}
{% block title %}COMBATE RASANTE - Área de Funcionários{% endblock %}

{% block content %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/employee_portal.css') }}">

<div class="sp-page">
  <div class="sp-wrap">
    <!-- Sidebar -->
    <aside class="sp-sidebar">
      <div class="sp-brand">
        <div class="sp-logo">CR</div>
        <div>
          <div class="sp-title">Área de Funcionários</div>
          <div class="sp-subtitle">Documentos e arquivos</div>
        </div>
      </div>

      <nav class="sp-nav">
        <a class="sp-nav-item active" href="{{ url_for('employee.files') }}">Documentos</a>
        <a class="sp-nav-item" href="{{ url_for('employee.logout') }}">Sair</a>
      </nav>

      <div class="sp-sidebar-footer">
        <div class="sp-user">
          <div class="sp-user-avatar">{{ (employee.name or "F")[:1]|upper }}</div>
          <div class="sp-user-meta">
            <div class="sp-user-name">{{ employee.name }}</div>
            <div class="sp-user-role">{{ employee.username }}</div>
          </div>
        </div>
      </div>
    </aside>

    <!-- Main -->
    <main class="sp-main">
      <!-- Topbar -->
      <div class="sp-topbar">
        <div class="sp-breadcrumbs" aria-label="breadcrumb">
          <a class="sp-crumb-link" href="{{ url_for('employee.files') }}">Documentos</a>
          {% for c in crumbs %}
            <span class="sp-sep">/</span>
            <a class="sp-crumb-link" href="{{ url_for('employee.files', path=c.path) }}">{{ c.name }}</a>
          {% endfor %}
        </div>

        <div class="sp-actions">
          <div class="sp-search">
            <input id="spSearch" type="text" placeholder="Pesquisar..." autocomplete="off">
          </div>

          <button class="sp-btn sp-btn-secondary" type="button" data-modal-open="modalFolder">
            + Nova pasta
          </button>

          <button class="sp-btn sp-btn-primary" type="button" data-modal-open="modalUpload">
            ⬆ Upload
          </button>
        </div>
      </div>

      <!-- Header -->
      <div class="sp-list-head">
        <div class="sp-list-title">
          <h2>Arquivos</h2>
          <div class="sp-muted">{{ items|length }} itens</div>
        </div>

        <div class="sp-sort">
          <label class="sp-muted">Ordenar:</label>
          <select id="spSort">
            <option value="name">Nome</option>
            <option value="type">Tipo</option>
            <option value="size">Tamanho</option>
            <option value="modified">Modificado</option>
          </select>
        </div>
      </div>

      <!-- Table -->
      <div class="sp-table" role="table">
        <div class="sp-row sp-row-head" role="row">
          <div class="sp-col-name" role="columnheader">Nome</div>
          <div class="sp-col-type" role="columnheader">Tipo</div>
          <div class="sp-col-size" role="columnheader">Tamanho</div>
          <div class="sp-col-mod" role="columnheader">Modificado</div>
          <div class="sp-col-actions" role="columnheader">Ações</div>
        </div>

        <div id="spRows">
          {% for it in items %}
          <div class="sp-row sp-row-item"
               role="row"
               data-name="{{ it.display|lower }}"
               data-type="{{ it.type|lower }}"
               data-size="{{ it.size_bytes or 0 }}"
               data-modified="{{ it.modified_ts or 0 }}"
               data-folder="{{ 1 if it.is_folder else 0 }}">
            <div class="sp-col-name" role="cell">
              <div class="sp-name">
                {% set ext = (it.type|lower) if it.type is defined else '' %}
                {% if it.is_folder %}
                  {% set icon = 'icons/folder.svg' %}
                {% elif ext in ['png','jpg','jpeg','gif','webp','bmp','svg'] %}
                  {% set icon = 'icons/image.svg' %}
                {% elif ext == 'pdf' %}
                  {% set icon = 'icons/pdf.svg' %}
                {% elif ext in ['kml','kmz'] %}
                  {% set icon = 'icons/kml.svg' %}
                {% else %}
                  {% set icon = 'icons/file.svg' %}
                {% endif %}
                <img class="sp-ico" src="{{ url_for('static', filename=icon) }}" alt="">
                {% if it.is_folder %}
                  <a class="sp-link" href="{{ it.href }}">{{ it.display }}</a>
                {% else %}
                  <a class="sp-link file-preview-link"
                     href="{{ url_for('employee.preview', file_id=it.file_id) }}"
                     data-name="{{ it.display }}"
                     data-filename="{{ it.name }}"
                     data-ext="{{ it.type|lower }}">
                    {{ it.display }}
                  </a>
                {% endif %}
              </div>
              {% if not it.is_folder and it.description %}
                <div class="sp-desc">{{ it.description }}</div>
              {% endif %}
            </div>

            <div class="sp-col-type" role="cell"><span class="sp-pill">{{ it.type }}</span></div>
            <div class="sp-col-size" role="cell"><span class="sp-muted">{{ it.size_human }}</span></div>
            <div class="sp-col-mod" role="cell"><span class="sp-muted">{{ it.modified_human }}</span></div>

            <div class="sp-col-actions" role="cell">
              {% if it.is_folder %}
                <a class="sp-action" href="{{ it.href }}">Abrir</a>
                <a class="sp-action" href="{{ it.download_href }}">Baixar</a>

                <form class="sp-action-form" method="post" action="{{ it.rename_folder_href }}" data-rename-folder-form>
                  <input type="hidden" name="path" value="{{ current_path }}">
                  <input type="hidden" name="old_name" value="{{ it.display }}">
                  <input type="hidden" name="new_name" value="">
                  <button class="sp-action" type="button" data-rename-folder-btn data-current="{{ it.display }}">Renomear</button>
                </form>

                <form class="sp-action-form" method="post" action="{{ it.delete_folder_href }}" data-delete-folder-form>
                  <input type="hidden" name="path" value="{{ current_path }}">
                  <input type="hidden" name="name" value="{{ it.display }}">
                  <button class="sp-action danger" type="button" data-delete-folder-btn>Excluir</button>
                </form>
              {% else %}
                <a class="sp-action" href="{{ it.download_href }}">Baixar</a>

                <form class="sp-action-form" method="post" action="{{ it.rename_href }}" data-rename-form>
                  <input type="hidden" name="path" value="{{ current_path }}">
                  <input type="hidden" name="new_title" value="">
                  <button class="sp-action" type="button" data-rename-btn data-current="{{ it.display }}">Renomear</button>
                </form>

                <form class="sp-action-form" method="post" action="{{ it.delete_href }}" data-delete-form>
                  <input type="hidden" name="path" value="{{ current_path }}">
                  <button class="sp-action danger" type="button" data-delete-btn>Excluir</button>
                </form>
              {% endif %}
            </div>
          </div>
          {% endfor %}
        </div>
      </div>

      <div id="spEmpty" class="sp-empty" style="display:none;">Nenhum item encontrado.</div>
    </main>
  </div>
</div>

<!-- Modal: Nova pasta -->
<div class="sp-modal" id="modalFolder" aria-hidden="true">
  <div class="sp-modal-backdrop" data-modal-close></div>
  <div class="sp-modal-card" role="dialog" aria-modal="true" aria-labelledby="modalFolderTitle">
    <div class="sp-modal-head">
      <div>
        <div class="sp-modal-title" id="modalFolderTitle">Criar nova pasta</div>
        <div class="sp-muted">Pasta será criada dentro do caminho atual.</div>
      </div>
      <button class="sp-icon-btn" type="button" data-modal-close>✕</button>
    </div>

    <form method="post" action="{{ url_for('employee.mkdir') }}" class="sp-form">
      <input type="hidden" name="path" value="{{ current_path }}">
      <label class="sp-label">Nome da pasta</label>
      <input class="sp-input" type="text" name="name" placeholder="Ex: Relatórios" required>

      <div class="sp-form-actions">
        <button class="sp-btn sp-btn-secondary" type="button" data-modal-close>Cancelar</button>
        <button class="sp-btn sp-btn-primary" type="submit">Criar</button>
      </div>
    </form>
  </div>
</div>

<!-- Modal: Upload -->
<div class="sp-modal" id="modalUpload" aria-hidden="true">
  <div class="sp-modal-backdrop" data-modal-close></div>
  <div class="sp-modal-card" role="dialog" aria-modal="true" aria-labelledby="modalUploadTitle">
    <div class="sp-modal-head">
      <div>
        <div class="sp-modal-title" id="modalUploadTitle">Enviar arquivo</div>
        <div class="sp-muted">O arquivo ficará disponível para a equipe.</div>
      </div>
      <button class="sp-icon-btn" type="button" data-modal-close>✕</button>
    </div>

    <form method="post" action="{{ url_for('employee.upload') }}" enctype="multipart/form-data" class="sp-form">
      <input type="hidden" name="path" value="{{ current_path }}">

      <label class="sp-label">Arquivo</label>
      <input class="sp-input" type="file" name="file" required>

      <label class="sp-label">Nome exibido (opcional)</label>
      <input class="sp-input" type="text" name="title" placeholder="Ex: Relatório semanal">

      <label class="sp-label">Descrição (opcional)</label>
      <textarea class="sp-textarea" name="description" rows="3" placeholder="Observações..."></textarea>

      <div class="sp-form-actions">
        <button class="sp-btn sp-btn-secondary" type="button" data-modal-close>Cancelar</button>
        <button class="sp-btn sp-btn-primary" type="submit">Enviar</button>
      </div>
    </form>
  </div>
</div>


<!-- Modal: Pré-visualização de arquivo -->
<div id="previewModal" style="
  display:none; position:fixed; inset:0; background:rgba(0,0,0,.60);
  z-index:9999; align-items:center; justify-content:center; padding:20px;">
  <div style="
    width:min(1100px, 96vw); height:min(740px, 88vh);
    background:rgba(255,255,255,.10); backdrop-filter: blur(10px);
    border-radius:18px; overflow:hidden; border:1px solid rgba(255,255,255,.25);
    display:flex; flex-direction:column;">
    <div style="display:flex; align-items:center; justify-content:space-between;
      padding:12px 14px; color:#fff; font-weight:700; gap:10px;">
      <div id="previewTitle" style="min-width:0; flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;"></div>
      <a id="previewOpenNewTab" href="#" target="_blank" rel="noopener" style="
        color:#fff; text-decoration:none; background:rgba(255,255,255,.15);
        padding:8px 10px; border-radius:10px; font-weight:600;">
        Abrir em nova aba ↗
      </a>
      <button id="closePreview" type="button" style="
        background:rgba(255,255,255,.15); color:#fff; border:none;
        padding:8px 10px; border-radius:10px; cursor:pointer; font-weight:700;">
        Fechar ✕
      </button>
    </div>

    <div id="previewBody" style="flex:1; background:rgba(0,0,0,.22);">
      <!-- conteúdo entra aqui -->
    </div>
  </div>
</div>

<script>
(function () {
  const modal = document.getElementById("previewModal");
  const body = document.getElementById("previewBody");
  const title = document.getElementById("previewTitle");
  const closeBtn = document.getElementById("closePreview");
  const openNewTab = document.getElementById("previewOpenNewTab");

  function openModal() { modal.style.display = "flex"; }
  function closeModal() {
    modal.style.display = "none";
    body.innerHTML = "";
    title.textContent = "";
    openNewTab.href = "#";
  }

  closeBtn.addEventListener("click", closeModal);
  modal.addEventListener("click", (e) => { if (e.target === modal) closeModal(); });
  document.addEventListener("keydown", (e) => { if (e.key === "Escape") closeModal(); });

  function extOf(filename) {
    const parts = (filename || "").toLowerCase().split(".");
    return parts.length > 1 ? parts.pop() : "";
  }
  function isImage(ext) { return ["png","jpg","jpeg","gif","webp","bmp","svg"].includes(ext); }
  function isPdf(ext) { return ext === "pdf"; }

  // Delegação: funciona mesmo se a lista atualizar
  document.addEventListener("click", (e) => {
    const a = e.target.closest(".file-preview-link");
    if (!a) return;

    // se o usuário clicou com Ctrl/Command/Mouse middle, deixa abrir em nova aba
    if (e.ctrlKey || e.metaKey || e.shiftKey || e.button === 1) return;

    e.preventDefault();

    const url = a.getAttribute("href");
    const displayName = a.dataset.name || a.textContent.trim() || "Arquivo";
    const filename = a.dataset.filename || displayName;
    const extHint = (a.dataset.ext || "").toLowerCase();
    const ext = extHint || extOf(filename);

    title.textContent = displayName;
    openNewTab.href = url;

    if (isImage(ext)) {
      body.innerHTML = `
        <div style="width:100%; height:100%; display:flex; align-items:center; justify-content:center;">
          <img src="${url}" alt="${displayName}" style="max-width:100%; max-height:100%; object-fit:contain;">
        </div>`;
      openModal();
      return;
    }

    if (isPdf(ext)) {
      body.innerHTML = `<iframe src="${url}" style="width:100%; height:100%; border:0;"></iframe>`;
      openModal();
      return;
    }

    // Outros tipos: tenta abrir em iframe (alguns browsers suportam), senão o usuário tem a opção de nova aba/baixar
    body.innerHTML = `
      <div style="padding:16px; color:#fff; line-height:1.4;">
        <p style="margin:0 0 10px 0;">
          Este tipo de arquivo pode não ter pré-visualização embutida.
        </p>
        <p style="margin:0;">
          Tente <strong>Abrir em nova aba</strong>. Se não abrir, use o botão <strong>Baixar</strong> na lista.
        </p>
      </div>`;
    openModal();
  });
})();
</script>

<script src="{{ url_for('static', filename='js/employee_portal.js') }}"></script>
{% endblock %}
